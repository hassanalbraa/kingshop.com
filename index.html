<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KING STORE — متجر الألعاب</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
body {margin:0; font-family:'Poppins',sans-serif; background:#f0f4ff; display:flex; justify-content:center; align-items:center; min-height:100vh;}
.container {width:95%; max-width:600px; background:white; padding:24px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
h1,h2,h3 {margin:12px 0;}
h1 {font-size:2rem; text-align:center; background:linear-gradient(90deg,#007bff,#00c3ff); -webkit-background-clip:text; color:transparent;}
.card {padding:12px; border-radius:12px; background:#e6f0ff; margin:6px 0; cursor:pointer; transition:0.2s; border:1px solid #cfe0ff;}
.card.selected {border:2px solid #007bff; background:#d0e4ff;}
.btn {padding:10px 20px; background:#007bff; color:white; border:none; border-radius:12px; cursor:pointer; margin-top:12px;}
#offersContainer {margin-top:16px;}
#loginContainer, #storeContainer, #settingsContainer {display:none;}
input {padding:8px; border-radius:8px; border:1px solid #bcd7ff; width:100%; margin:4px 0;}
</style>
</head>
<body>

<div class="container">

  <!-- Login -->
  <div id="loginContainer">
    <h1>تسجيل الدخول</h1>
    <input type="text" id="username" placeholder="اسم المستخدم">
    <input type="password" id="password" placeholder="كلمة المرور">
    <button class="btn" onclick="login()">دخول</button>
  </div>

  <!-- Store -->
  <div id="storeContainer">
    <h1>مرحباً، <span id="userDisplay"></span></h1>
    <h3>رصيدك: <span id="balanceDisplay">0</span> ج.س</h3>
    <div id="offersContainer"></div>
    <div style="text-align:center;">
      <button class="btn" onclick="logout()">خروج</button>
      <button class="btn" onclick="openSettings()">الإعدادات</button>
    </div>
  </div>

  <!-- Settings -->
  <div id="settingsContainer">
    <h1>الإعدادات</h1>
    <input type="password" id="newPassword" placeholder="كلمة المرور الجديدة">
    <button class="btn" onclick="changePassword()">تغيير كلمة المرور</button>
    <button class="btn" onclick="backToStore()">رجوع</button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
// تهيئة Supabase
const supabaseUrl = 'https://koarutyywmtdtjibqgfe.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvYXJ1dHl5d210ZHRqaWJxZ2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTczNjcsImV4cCI6MjA3Nzk5MzM2N30.k5Byn6zlRVSbC1_YULdJGBq7vNJRA3AyWDRqkI5dDKI';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

// حالة المستخدم الحالي
let currentUser = null;

// تسجيل الدخول
async function login(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  if(!username || !password){ alert('الرجاء إدخال جميع البيانات'); return; }

  let { data, error } = await supabase
    .from('users')
    .select('*')
    .eq('username', username)
    .eq('password', password)
    .single();

  if(error || !data){ alert('اسم المستخدم أو كلمة المرور خاطئة'); return; }

  currentUser = data;
  showStore();
}

// عرض المتجر
async function showStore(){
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('storeContainer').style.display = 'block';
  document.getElementById('userDisplay').textContent = currentUser.username;
  document.getElementById('balanceDisplay').textContent = currentUser.balance;

  // جلب العروض
  let { data: offers, error } = await supabase
    .from('offers')
    .select('*');

  if(error){ alert('حدث خطأ في جلب العروض'); return; }

  const container = document.getElementById('offersContainer');
  container.innerHTML = '<h3>اختر عرض الشحن</h3>';
  offers.forEach(offer => {
    const div = document.createElement('div');
    div.className = 'card';
    div.textContent = `${offer.game} — ${offer.amount} ${offer.currency} — ${offer.priceSDG} ج.س`;
    div.onclick = () => buyOffer(offer);
    container.appendChild(div);
  });
}

// شراء العرض
async function buyOffer(offer){
  if(currentUser.balance < offer.priceSDG){ alert('رصيدك غير كافٍ'); return; }

  const { data, error } = await supabase
    .from('users')
    .update({ balance: currentUser.balance - offer.priceSDG })
    .eq('id', currentUser.id)
    .select();

  if(error){ alert('حدث خطأ'); return; }

  currentUser.balance -= offer.priceSDG;
  document.getElementById('balanceDisplay').textContent = currentUser.balance;
  alert(`تم شراء: ${offer.amount} ${offer.currency}`);
}

// تغيير كلمة المرور
async function changePassword(){
  const newPass = document.getElementById('newPassword').value.trim();
  if(!newPass){ alert('الرجاء إدخال كلمة المرور الجديدة'); return; }

  const { data, error } = await supabase
    .from('users')
    .update({ password: newPass })
    .eq('id', currentUser.id)
    .select();

  if(error){ alert('حدث خطأ'); return; }
  alert('تم تغيير كلمة المرور');
}

// إعدادات
function openSettings(){
  document.getElementById('storeContainer').style.display = 'none';
  document.getElementById('settingsContainer').style.display = 'block';
}
function backToStore(){
  document.getElementById('settingsContainer').style.display = 'none';
  document.getElementById('storeContainer').style.display = 'block';
}

// خروج
function logout(){
  currentUser = null;
  document.getElementById('storeContainer').style.display = 'none';
  document.getElementById('loginContainer').style.display = 'block';
}
</script>
</body>
</html>
